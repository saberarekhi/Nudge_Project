{% macro report_card(report, current_user) -%}
<div class="report-card">
  <div class="card h-100">
    {% if report.image_filename %}
      <div class="report-image-container"
           data-bs-toggle="modal"
           data-bs-target="#imageModal{{ report.id }}">
        <div class="report-image-wrapper">
          <img src="{{ url_for('uploaded_file', user_id=report.author.id, filename=report.image_filename) }}?v={{ cache_buster }}"
               class="report-image img-fluid"
               alt="{{ _('تصویر گزارش') }} #{{ report.id }}"
               loading="lazy"
               onerror="handleImageError(this)">
        </div>
      </div>

      <div class="modal fade image-modal"
           id="imageModal{{ report.id }}"
           tabindex="-1"
           aria-hidden="true"
           aria-labelledby="modalTitle{{ report.id }}">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalTitle{{ report.id }}">
                {{ _('تصویر گزارش') }}
                <span class="badge bg-secondary">{{ report.report_code or report.id }}</span>
              </h5>
              <button type="button" class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="{{ _('بستن') }}"></button>
            </div>
            <div class="modal-body text-center">
              <div id="loading{{ report.id }}" class="text-center mt-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">{{ _('در حال بارگذاری...') }}</span>
                </div>
              </div>
              <img id="modalImage{{ report.id }}" src=""
                   alt="{{ _('تصویر گزارش') }}"
                   class="img-fluid modal-img" style="display: none;">
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    <div class="card-body d-flex flex-column">
      <div class="d-flex justify-content-between mb-2">
        <small class="text-muted">
          {{ _('توسط:') }} <a href="{{ url_for('profile', user_id=report.author.id) }}">
            {{ report.author.username }}
          </a>
        </small>
        <time class="text-muted" datetime="{{ report.timestamp.isoformat() }}">
          {{ report.timestamp.strftime('%Y-%m-%d') }}
        </time>
      </div>

      <h6 class="report-title">{{ report.description|truncate(100) }}</h6>

      <div class="mt-auto">
        {% set badge_map = { 'approved': 'success', 'rejected': 'danger', 'pending' : 'warning' } %}
        <span class="badge bg-{{ badge_map.get(report.status, 'secondary') }}">
          {% if report.status == 'approved' %}
            {{ _('تایید شده') }}
          {% elif report.status == 'rejected' %}
            {{ _('رد شده') }}
          {% else %}
            {{ _('در انتظار') }}
          {% endif %}
        </span>

        <div class="d-flex justify-content-between align-items-center mt-2">
          <div class="like-btn" data-report-id="{{ report.id }}" aria-label="{{ _('پسندیدن') }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                 fill="{{ 'red' if current_user and current_user.id in (report.likes|map(attribute='user_id')) else 'currentColor' }}"
                 class="bi bi-heart-fill" viewBox="0 0 16 16">
              <path d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
            </svg>
            <span class="like-count ms-1">{{ report.likes|length }}</span>
          </div>

          <a data-bs-toggle="collapse" href="#comments-{{ report.id }}" role="button" aria-expanded="false" aria-controls="comments-{{ report.id }}">
            {{ _('کامنت‌ها') }} ({{ report.comments|length }})
          </a>
        </div>

        <div class="collapse mt-2" id="comments-{{ report.id }}">
          <div class="comments-section p-2 bg-light rounded mb-2">
            {% if report.comments %}
              {% for comment in report.comments %}
                <div class="mb-1">
                  <strong>{{ comment.user.username }}:</strong>
                  <span>{{ comment.text }}</span>
                </div>
              {% endfor %}
            {% else %}
              <p class="text-center text-muted small m-0">{{ _('هنوز کامنتی ثبت نشده است.') }}</p>
            {% endif %}
          </div>
          
          {% if current_user %}
          <form action="{{ url_for('comment_report', report_id=report.id) }}" method="POST" class="d-flex gap-2">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="text" name="comment_text" class="form-control form-control-sm" placeholder="{{ _('نظر خود را بنویسید...') }}" required>
              <button type="submit" class="btn btn-primary btn-sm">{{ _('ارسال') }}</button>
          </form>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{%- endmacro %}